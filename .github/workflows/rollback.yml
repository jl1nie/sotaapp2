name: Rollback

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to rollback to (e.g., v0.1.2 or commit SHA)'
        required: true
        type: string
      confirm:
        description: 'Type "rollback" to confirm'
        required: true
        type: string

env:
  REGISTRY: docker.io
  IMAGE_NAME: jl1nie/sotaapp2

jobs:
  rollback:
    name: Rollback to Previous Version
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.confirm == 'rollback' }}
    environment: production

    steps:
      - name: Validate confirmation
        if: ${{ github.event.inputs.confirm != 'rollback' }}
        run: |
          echo "::error::Confirmation failed. Please type 'rollback' to confirm."
          exit 1

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Get current status
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "Current deployment status:"
          flyctl status || true
          echo ""
          CURRENT_IMAGE=$(flyctl status --json 2>/dev/null | jq -r '.Machines[0].config.image // "unknown"' || echo "unknown")
          echo "Current image: ${CURRENT_IMAGE}"

      - name: Perform rollback
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          TARGET_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.image_tag }}"
          echo "Rolling back to: ${TARGET_IMAGE}"
          flyctl deploy --image "${TARGET_IMAGE}"

      - name: Verify rollback health
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "Waiting for rollback to stabilize..."
          sleep 30

          HEALTH_URL="https://sotaapp2.fly.dev/health"
          echo "Checking health endpoint: ${HEALTH_URL}"

          for i in 1 2 3 4 5; do
            if curl -sf "${HEALTH_URL}" > /dev/null; then
              echo "::notice::Rollback successful! Health check passed."
              exit 0
            fi
            echo "Attempt $i failed, retrying in 10s..."
            sleep 10
          done

          echo "::error::Health check failed after rollback"
          exit 1

      - name: Post-rollback status
        if: always()
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "Final deployment status:"
          flyctl status || true
