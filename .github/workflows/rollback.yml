name: Rollback

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to rollback to (SHA or version tag)'
        required: true
        type: string
      confirm:
        description: 'Type "rollback" to confirm'
        required: true
        type: string

env:
  REGISTRY: docker.io
  IMAGE_NAME: jl1nie/sotaapp2
  FLY_APP: sotaapp2

jobs:
  rollback:
    name: Rollback
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.confirm == 'rollback' }}
    environment: production

    steps:
      - name: Validate confirmation
        if: ${{ github.event.inputs.confirm != 'rollback' }}
        run: |
          echo "::error::Type 'rollback' to confirm"
          exit 1

      - uses: actions/checkout@v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Get current status
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "## Current Status" >> $GITHUB_STEP_SUMMARY
          CURRENT=$(flyctl status --json 2>/dev/null | jq -r '.Machines[0].config.image // "unknown"')
          echo "Current image: ${CURRENT}"
          echo "| Current | \`${CURRENT}\` |" >> $GITHUB_STEP_SUMMARY

      - name: Rollback
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          TARGET="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.image_tag }}"
          echo "Rolling back to: ${TARGET}"
          echo "| Target | \`${TARGET}\` |" >> $GITHUB_STEP_SUMMARY
          flyctl deploy --image "${TARGET}"

      - name: Health check
        run: |
          echo "Waiting for rollback..."
          sleep 30

          HEALTH_URL="https://${FLY_APP}.fly.dev/api/v2/health"
          for i in 1 2 3 4 5; do
            if curl -sf "${HEALTH_URL}" > /dev/null; then
              echo "::notice::Rollback successful!"
              echo "| Result | Success |" >> $GITHUB_STEP_SUMMARY
              exit 0
            fi
            echo "Attempt $i failed, retrying in 10s..."
            sleep 10
          done

          echo "::error::Health check failed after rollback"
          echo "| Result | Failed |" >> $GITHUB_STEP_SUMMARY
          exit 1

      - name: Final status
        if: always()
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: flyctl status
