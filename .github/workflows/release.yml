name: Release

on:
  push:
    tags:
      - 'v*'

env:
  REGISTRY: docker.io
  IMAGE_NAME: jl1nie/sotaapp2
  SQLX_OFFLINE: true
  FLY_APP: sotaapp2

jobs:
  # テストを実行
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: Lint
        run: |
          cargo fmt --all -- --check
          cargo clippy --all-targets --all-features -- -D warnings

      - name: Test
        run: cargo nextest run --workspace --test-threads=1

  # DBバックアップ
  backup-database:
    name: Backup Database
    runs-on: ubuntu-latest
    outputs:
      backup_file: ${{ steps.backup.outputs.backup_file }}

    steps:
      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Download database
        id: backup
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          VERSION="${{ github.ref_name }}"
          BACKUP_FILE="sotaapp2_${VERSION}.db"

          flyctl ssh sftp get /data/sotaapp2.db "./${BACKUP_FILE}" || {
            echo "::warning::Database download failed"
            exit 0
          }

          if [ -f "${BACKUP_FILE}" ]; then
            SIZE=$(ls -lh "${BACKUP_FILE}" | awk '{print $5}')
            echo "Downloaded: ${BACKUP_FILE} (${SIZE})"
            echo "backup_file=${BACKUP_FILE}" >> $GITHUB_OUTPUT
          fi

      - name: Upload backup
        if: steps.backup.outputs.backup_file != ''
        uses: actions/upload-artifact@v4
        with:
          name: db-backup-${{ github.ref_name }}
          path: ${{ steps.backup.outputs.backup_file }}
          retention-days: 90

  # Docker ビルド & プッシュ
  build-and-push:
    name: Build & Push
    runs-on: ubuntu-latest
    needs: test
    outputs:
      version: ${{ steps.meta.outputs.version }}
      tags: ${{ steps.meta.outputs.tags }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run E2E tests
        run: |
          # latest タグを使用（確実に存在する）
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest sotaapp2:test
          ./scripts/docker-e2e-test.sh sotaapp2:test

  # Fly.io デプロイ
  deploy:
    name: Deploy to Fly.io
    runs-on: ubuntu-latest
    needs: [backup-database, build-and-push]
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Get current image
        id: current
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          CURRENT=$(flyctl status --json 2>/dev/null | jq -r '.Machines[0].config.image // "unknown"')
          echo "current_image=${CURRENT}" >> $GITHUB_OUTPUT

      - name: Deploy
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: flyctl deploy --remote-only

      - name: Health check
        id: health
        run: |
          sleep 30
          HEALTH_URL="https://${FLY_APP}.fly.dev/api/v2/health"
          for i in 1 2 3 4 5; do
            if curl -sf "${HEALTH_URL}" > /dev/null; then
              echo "::notice::Deploy successful!"
              exit 0
            fi
            sleep 10
          done
          echo "::error::Health check failed"
          exit 1

      - name: Rollback on failure
        if: failure() && steps.current.outputs.current_image != 'unknown'
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "::error::Rolling back to ${{ steps.current.outputs.current_image }}"
          flyctl deploy --image "${{ steps.current.outputs.current_image }}"

  # GitHub Release 作成
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy]
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          # 前のタグを取得
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$PREV_TAG" ]; then
            echo "Changes since ${PREV_TAG}:" > CHANGELOG.md
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s" >> CHANGELOG.md
          else
            echo "Initial release" > CHANGELOG.md
          fi

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          body_path: CHANGELOG.md
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # サマリ
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [backup-database, build-and-push, deploy, create-release]
    if: always()

    steps:
      - name: Create summary
        run: |
          echo "## Release ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build-and-push.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backup | ${{ needs.backup-database.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Release | ${{ needs.create-release.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Docker tags: \`${{ needs.build-and-push.outputs.tags }}\`" >> $GITHUB_STEP_SUMMARY
