<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Consle</title>
</head>

<body>
    <h2> SOTA/POTA Reference Table Maintenance</h2>

    <h4>Upload POTA Park list </h4>
    <form id="upload-pota" method="post" enctype="multipart/form-data">
        <input id="upload-pota-file" type="file" name="file">
        <button id="upload-pota-button" type="submit">Upload</button>
    </form>

    <h4>Upload SOTA Summits list </h4>
    <form id="import-summit" method="post" enctype="multipart/form-data">
        <input id="import-summit-file" type="file" name="file">
        <button id="import-summit-button" type="submit">Upload</button>
    </form>

    <h4>Upload SOTA JA Summits list </h4>
    <form id="upload-ja-summit" method="post" enctype="multipart/form-data">
        <input id="upload-ja-summit-file" type="file" name="file">
        <button id="upload-ja-summit-button" type="submit">Upload</button>
    </form>

    <hr>
    <h2> JCC/JCG Table Maintenance</h2>
    <h4>Upload JCC-JCG list </h4>
    <form id="upload-jcc" method="post" enctype="multipart/form-data">
        <input id="upload-jcc-file" type="file" name="file">
        <button id="upload-jcc-button" type="submit">Upload</button>
    </form>

    <hr>
    <h2> Migration Tool </h2>
    <h4>Migrate POTA legacy DB <div style="color: red;"> (DANGER!)</div>
    </h4>
    <form id="migrate-legacy-log" method="get">
        <label for="migrate-legacy-log-name">DBName</label>
        <input id="migrate-legacy-log-name" type="text" name="text" value="sqlite:(NeedRewrite)/jaffpota.db">
        <input id="migrate-legacy-log-button" type="submit" value="Migrate">
    </form>

    <h4>POTA Log Statistics</h4>
    <form id="log-stat" method="get">
        <input id="log-stat-button" type="submit" value="Get">
    </form>

    <hr>
    <!--
    <h4>Update SOTA Summits list </h4>
    <form id="import-activation" method="post" enctype="multipart/form-data">
        <input id="import-activation-file" type="file" name="file">
        <button id="import-activation-button" type="submit">Upload</button>
    </form>

    <h4>Upload POTA Log </h4>
    <form id="upload-pota-log" method="post" enctype="multipart/form-data">
        <input id="upload-pota-log-file" type="file" name="file">
        <button id="upload-pota-log-button" type="submit">Upload</button>
    </form>
-->
    <h2> Search Tools </h2>
    <h4>Reference list</h4>
    <form id="reflist" method="get">
        <label for="prog-reflist">Program:</label>
        <select id="prog-reflist" name="prog-refid">
            <option value="SOTA">SOTA</option>
            <option value="POTA">POTA</option>
        </select><br><br>
        <label for="reflist-limit">Limit:</label>
        <input type="text" id="reflist-limit" name="reflist-limit" value="10"><br><br>
        <label for="reflist-offset">Offset:</label>
        <input type="text" id="reflist-offset" name="reflist-offset" value="0"><br><br>

        <input type="submit" value="送信">
    </form>

    <h4>Search by code</h4>
    <form id="search-refid" method="get">
        <label for="prog-refid">Program:</label>
        <select id="prog-refid" name="prog-refid">
            <option value="SOTA">SOTA</option>
            <option value="POTA">POTA</option>
        </select><br><br>
        <label for="ref_id">Reference:</label>
        <input type="text" id="ref_id" name="ref_id"><br><br>
        <input type="submit" value="送信">
    </form>

    <h4>Search by location</h4>
    <form id="search-location" method="get">
        <label for="min_lon">Min Lon:</label>
        <input type="text" id="min_lon" name="min_lon" value="138.860"><br><br>

        <label for="min_lat">Min Lat:</label>
        <input type="text" id="min_lat" name="min_lat" value="35.3726"><br><br>

        <label for="max_lon">Max Lon:</label>
        <input type="text" id="max_lon" name="max_lon" value="139.7213"><br><br>

        <label for="max_lat">Max Lat:</label>
        <input type="text" id="max_lat" name="max_lat" value="35.7480"><br><br>

        <label for="min_elev">Min elev:</label>
        <input type="text" id="min_elev" name="min_elev" value="1500"><br><br>

        <label for="min_area">Min area:</label>
        <input type="text" id="min_area" name="min_area" value="0"><br><br>

        <label for="max_results">Max Results:</label>
        <input type="text" id="max_results" name="max_results" value="500"><br><br>

        <input type="submit" value="送信">
    </form>

    <h4>Search by location and distance</h4>
    <form id="search-location-dist" method="get">
        <label for="lon">Lon:</label>
        <input type="text" id="lon" name="lon" value="138.7277"><br><br>

        <label for="lat">Lat:</label>
        <input type="text" id="lat" name="lat" value="35.9176"><br><br>

        <label for="range">Distance:</label>
        <input type="text" id="dist" name="dist" value="200"><br><br>

        <input type="submit" value="送信">
    </form>

    <h4>Alerts</h4>
    <form id="alerts" method="get">
        <label for="after">Show alerts in :</label>
        <input type="text" id="alerts-after" name="after" value="1"><br><br>
        <input type="submit" value="送信">
    </form>

    <h4>Spots</h4>
    <form id="spots" method="get">
        <label for="after">Show spots in :</label>
        <input type="text" id="spots-after" name="after" value="1"><br><br>

        <input type="submit" value="送信">
    </form>

    <h4>APRS</h4>
    <form id="aprs" method="get">
        <label for="after">Show APRS in :</label>
        <input type="text" id="aprs-after" name="after" value="24"><br><br>

        <input type="submit" value="送信">
    </form>

    <h4>Search JCC/JCG by MuniCd</h4>
    <form id="search-jcc" method="get">
        <label for="lon">Lon:</label>
        <input type="text" id="lon" name="lon" value="138.9439"><br><br>
        <label for="lat">Lat:</label>
        <input type="text" id="lat" name="lat" value="35.8555"><br><br>
        <label for="ref_id">MuniCd:</label>
        <input type="text" id="municd" name="municd" value="13308"><br><br>
        <input type="submit" value="送信">
    </form>

    <h4>Latest Ap/Kp Index</h4>
    <form id="geomag" method="get">
        <input type="submit" value="送信">
    </form>

    <h4>Search Name</h4>
    <form id="search-name" method="get">
        <label for="name-field">Name:</label>
        <input type="text" id="name-field" name="name-field"><br><br>

        <label for="limit">Limit:</label>
        <input type="text" id="limit" name="limit" value="10"><br><br>
    </form>

    <!--
    <hr>
    <h4>Upload SOTA Log </h4>
        <form id="upload-sota-log" method="post" enctype="multipart/form-data">
        <input id="upload-sota-log-file" type="file" name="file">
        <button id="upload-sota-log-button" type="submit">Upload</button>
    </form>

    <h4>Analyze SOTA Log</h4>
        <form id="award-progress" method="get">
        <input type="submit" value="送信">
    </form>
    -->

    <h4>Search Result(JSON)</h4>
    <div id="result"></div>


    <script>
        const uid = "538b548f-12db-4230-b48d-46d8842b2da9";
        var logid = "none";
        var authToken = null;

        const url = new URL(document.documentURI);
        const baseurl = `${url.protocol}//${url.host}/api/v2`;
        const sotasearch = baseurl + '/sota/summits/search';
        const sotalist = baseurl + '/sota/summits';
        const importsota = baseurl + '/sota/import';
        const importsotaja = baseurl + '/sota/import/ja';
        const importactivation = baseurl + '/sota/update';
        const uploadsotalog = baseurl + '/sota/log';

        const potasearch = baseurl + '/pota/parks/search';
        const potalist = baseurl + '/pota/parks';
        const importpota = baseurl + '/pota/import';
        const uploadpotalog = baseurl + '/pota/log';
        const migratelegacylog = baseurl + '/pota/log-migrate';
        const potalogstat = baseurl + '/pota/log-stat';


        const locatejcc = baseurl + '/locator/jcc-jcg';
        const importjcc = baseurl + '/locator/jcc-jcg/import';
        const mapcode = baseurl + '/locator/mapcode';
        const geomag = baseurl + '/propagation/geomag';
        const searchurl = baseurl + '/search/full';
        const searchbreif = baseurl + '/search/brief';
        const alertsurl = baseurl + '/activation/alerts';
        const spotsurl = baseurl + '/activation/spots';
        const aprslogurl = baseurl + '/activation/aprs/track';
        ;

        async function getAuthToken() {
            const email = prompt('Enter your email:');
            const password = prompt('Enter your password:');
            const response = await fetch(baseurl + '/auth/signin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email: email,
                    password: password
                })
            });

            if (!response.ok) {
                alert("Authorization Failure");
                throw new Error('Failed to fetch auth token: ' + response.status);
            }

            const authToken = response.headers.get('Authorization');
            if (!authToken) {
                throw new Error('Authorization token not found in response');
            }

            return authToken;
        }

        async function uploadFile(url, inputid, buttonid) {
            event.preventDefault();

            if (!authToken) {
                authToken = await getAuthToken();
            }

            const fileInput = document.getElementById(inputid);
            const button = document.getElementById(buttonid);
            const resultDiv = document.getElementById('result');
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            button.disabled = true;

            fetch(url, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + authToken },
                body: formData
            })
                .then(response => {
                    if (response.ok) {
                        console.log('Success:', response.status);
                        resultDiv.textContent = 'Upload done: ' + response;
                    } else
                        throw new Error('HTTP error, status = ' + response.status);

                })
                .catch(error => {
                    authToken = null;
                    console.error('Error:', error.message);
                    resultDiv.textContent = 'Error: ' + error.message;
                })
                .finally(() => {
                    button.disabled = false;
                })
        };

        async function delete_data(url, buttonid) {
            event.preventDefault();
            const button = document.getElementById(buttonid);
            button.disabled = true;

            if (!authToken) {
                authToken = await getAuthToken();
            }

            fetch(url, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + authToken }
            })
                .then(response => {
                    if (response.ok) {
                        console.log('Success:', response.status);
                        resultDiv.textContent = 'DELETE done: ' + response.status;
                    } else {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                })
                .catch(error => {
                    authToken = null;
                    console.error('Error:', error);
                    resultDiv.textContent = 'Error: ' + response.status;
                })
                .finally(() => {
                    button.disabled = false;
                })
        };

        async function search(baseurl, param, auth = false) {
            event.preventDefault();

            let fullurl = baseurl;
            if (param != '') {
                fullurl += `?${param}`;
            }

            if (auth && !authToken) {
                authToken = await getAuthToken();
            }

            const resultDiv = document.getElementById('result');

            fetch(fullurl, {
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + authToken }
            })
                .then(response => {
                    if (response.ok) { return response.json(); }
                    else {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                })
                .then(data => {
                    console.log('Success:', data);
                    resultDiv.textContent = JSON.stringify(data, null, 2);
                })
                .catch(error => {
                    console.error('Error:', error);
                    resultDiv.textContent = 'Error: ' + error;
                });
        };

        document.getElementById('import-summit')
            .addEventListener('submit', function (event) {
                event.preventDefault();
                uploadFile(importsota, 'import-summit-file', 'import-summit-button');
            });
        /*
        document.getElementById('import-activation')
            .addEventListener('submit', function (event) {
                event.preventDefault();
                uploadFile(importactivation, 'import-activation-file', 'import-activation-button');
            });
        */
        document.getElementById('upload-ja-summit')
            .addEventListener('submit', function (event) {
                event.preventDefault();
                uploadFile(importsotaja, 'upload-ja-summit-file', 'upload-ja-summit-button');
            });

        document.getElementById('upload-pota')
            .addEventListener('submit', function (event) {
                event.preventDefault();
                uploadFile(importpota, 'upload-pota-file', 'upload-pota-button');
            });
        /*
        document.getElementById('upload-pota-log')
            .addEventListener('submit', function (event) {
                event.preventDefault();
                let eid = encodeURIComponent(logid);
                uploadFile(uploadpotalog + `/${eid}`, 'upload-pota-log-file', 'upload-pota-log-button');
            });
        */
        document.getElementById('migrate-legacy-log')
            .addEventListener('submit', async function (event) {
                event.preventDefault();
                let name = document.getElementById('migrate-legacy-log-name').value;
                let param = `name=${name}`;
                search(migratelegacylog, param, true)
            });

        document.getElementById('log-stat')
            .addEventListener('submit', function (event) {
                event.preventDefault()
                search(potalogstat, '');
            });


        document.getElementById('upload-jcc')
            .addEventListener('submit', function (event) {
                event.preventDefault();
                uploadFile(importjcc, 'upload-jcc-file', 'upload-jcc-button');
            });

        document.getElementById('reflist')
            .addEventListener('submit', function (event) {
                event.preventDefault();
                let limit = document.getElementById('reflist-limit').value;
                let offset = document.getElementById('reflist-offset').value;
                let param = `limit=${limit}&offset=${offset}`;
                let prog = document.getElementById('prog-reflist').value;
                if (prog === 'SOTA') {
                    search(sotalist, param);
                } else if (prog === 'POTA') {
                    search(potalist, param);
                }
            });

        document.getElementById('search-refid')
            .addEventListener('submit', function (event) {
                event.preventDefault();
                let id = document.getElementById('ref_id').value;
                let eid = encodeURIComponent(id);
                let prog = document.getElementById('prog-refid').value;
                if (prog === 'SOTA') {
                    let url = sotalist + `/${eid}`;
                    search(url, '');
                } else if (prog === 'POTA') {
                    let url = potalist + `/${eid}`;
                    search(url, '');
                }
            });

        document.getElementById('search-jcc')
            .addEventListener('submit', function (event) {
                event.preventDefault();
                let muni = document.getElementById('municd').value;
                let lon = document.getElementById('lon').value;
                let lat = document.getElementById('lat').value;
                let param = `lon=${lon}&lat=${lat}&muni_code=${muni}`;
                search(locatejcc, param);
            });

        document.getElementById('geomag')
            .addEventListener('submit', function (event) {
                event.preventDefault();
                search(geomag, '');
            });

        document.getElementById('search-name')
            .addEventListener('input', function (event) {
                event.preventDefault();
                let name = document.getElementById('name-field').value;
                let limit = document.getElementById('limit').value;
                let param = `name=${name}&max_count=${limit}`;
                if (name.length > 2) {
                    search(searchbreif, param)
                }
            });

        document.getElementById('search-location')
            .addEventListener('submit', function (event) {
                event.preventDefault();
                let min_lon = document.getElementById('min_lon').value;
                let min_lat = document.getElementById('min_lat').value;
                let max_lon = document.getElementById('max_lon').value;
                let max_lat = document.getElementById('max_lat').value;
                let min_elev = document.getElementById('min_elev').value;
                let min_area = document.getElementById('min_area').value;
                let max_results = document.getElementById('max_results').value;
                let eid = encodeURIComponent(uid);
                let param = `user_id=${eid}&min_lon=${min_lon}&min_lat=${min_lat}&max_lon=${max_lon}&max_lat=${max_lat}&min_elev=${min_elev}&min_area=${min_area}&max_results=${max_results}`;
                search(searchurl, param);
            });

        document.getElementById('search-location-dist')
            .addEventListener('submit', function (event) {
                event.preventDefault();
                let lon = document.getElementById('lon').value;
                let lat = document.getElementById('lat').value;
                let dist = document.getElementById('dist').value;
                let param = `lon=${lon}&lat=${lat}&dist=${dist}`;
                search(searchurl, param);
            });

        document.getElementById('alerts')
            .addEventListener('submit', function (event) {
                event.preventDefault();
                //let pat = encodeURIComponent("^(JA|JP-)");
                let pat = encodeURIComponent("*");
                let after = document.getElementById('alerts-after').value;
                let param = `hours_ago=${after}&pat_ref=${pat}`;

                search(alertsurl, param);
            });

        document.getElementById('spots')
            .addEventListener('submit', function (event) {
                event.preventDefault();
                //let pat = encodeURIComponent("^(JA|JP-)");
                let pat = encodeURIComponent("*");
                let after = document.getElementById('spots-after').value;
                let param = `hours_ago=${after}&pat_ref=${pat}`;
                search(spotsurl, param);
            });

        document.getElementById('aprs')
            .addEventListener('submit', function (event) {
                event.preventDefault();
                let after = document.getElementById('aprs-after').value;
                let param = `hours_ago=${after}`;
                search(aprslogurl, param);
            });

        /*
        document.getElementById('upload-sota-log')
            .addEventListener('submit', function (event) {
                event.preventDefault();
                uploadFile(uploadsotalog, 'upload-sota-log-file', 'upload-sota-log-button');
            });
 
        document.getElementById('award-progress')
            .addEventListener('submit', function (event) {
                event.preventDefault();
                search(uploadsotalog, '');
            });
        */
    </script>
</body>