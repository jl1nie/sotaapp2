[env]
DOCKER_IMAGE = "jl1nie/sotaapp2"
DOCKER_TAG = "latest"

[config]
default_to_workspace = false

[tasks.set-env-docker.env]
DATABASE_URL = "sqlite:/data/sotaapp2.db"

# =============================================================================
# 開発タスク
# =============================================================================
[tasks.run]
description = "Run the application locally"
script = '''
#!/bin/bash
set -a
source .env
set +a
cargo run "$@"
'''

[tasks.dev]
description = "Alias for run"
alias = "run"

[tasks.stop]
description = "Stop the running application (kill process on port 8080)"
script = '''
#!/bin/bash
PID=$(lsof -ti :8080 2>/dev/null)
if [ -n "$PID" ]; then
    echo "Stopping process $PID on port 8080..."
    kill $PID 2>/dev/null || kill -9 $PID 2>/dev/null
    echo "Stopped."
else
    echo "No process running on port 8080."
fi
'''

[tasks.restart]
description = "Stop and run the application"
run_task = { name = ["stop", "run"] }

[tasks.build]
description = "Build the project"
command = "cargo"
args = ["build", "${@}"]

[tasks.check]
description = "Check the project for errors"
command = "cargo"
args = ["check", "${@}"]

[tasks.watch]
description = "Watch for changes and run fmt, clippy, test"
run_task = [{ name = ["fmt", "clippy", "test"] }]
watch = true

# =============================================================================
# 品質管理タスク
# =============================================================================
[tasks.fmt]
description = "Format code"
command = "cargo"
args = ["fmt", "--all", "${@}"]

[tasks.fmt-check]
description = "Check code formatting"
command = "cargo"
args = ["fmt", "--all", "--", "--check"]

[tasks.clippy]
description = "Run clippy linter"
command = "cargo"
args = ["clippy", "--all", "--all-targets", "${@}"]

[tasks.lint]
description = "Alias for clippy"
alias = "clippy"

[tasks.fix]
description = "Auto-fix clippy warnings"
command = "cargo"
args = ["clippy", "--all", "--all-targets", "--fix", "--allow-dirty", "--allow-staged"]

[tasks.test]
description = "Run tests with nextest"
install_crate = { crate_name = "cargo-nextest", binary = "cargo", test_arg = ["nextest", "--help"] }
script = '''
#!/bin/bash
set -a
source .env.test
set +a
cargo nextest run --workspace --status-level all --test-threads=1 "$@"
'''

[tasks.ci]
description = "Run full CI pipeline (fmt-check + clippy-strict + test)"
run_task = { name = ["fmt-check", "clippy-strict", "test"] }

[tasks.ci-quick]
description = "Run quick CI checks (clippy + test, no fmt)"
run_task = { name = ["clippy-strict", "test"] }

[tasks.clippy-strict]
description = "Run clippy with strict settings for CI"
command = "cargo"
args = ["clippy", "--all-targets", "--all-features", "--", "-D", "warnings"]

[tasks.test-ci]
description = "Run tests for CI (with cargo test instead of nextest)"
command = "cargo"
args = ["test", "--all", "--verbose"]

[tasks.build-release]
description = "Build release binary"
command = "cargo"
args = ["build", "--release"]

# =============================================================================
# フロントエンドタスク
# =============================================================================
[tasks.admin-build]
description = "Build admin frontend"
script = '''
#!/bin/bash
cd admin && npm run build
'''

[tasks.admin-dev]
description = "Run admin frontend dev server"
script = '''
#!/bin/bash
cd admin && npm run dev
'''

[tasks.admin-install]
description = "Install admin frontend dependencies"
script = '''
#!/bin/bash
cd admin && npm install
'''

# =============================================================================
# データベースタスク
# =============================================================================
[tasks.migrate]
description = "Run database migrations"
install_crate = { crate_name = "sqlx-cli", binary = "sqlx", test_arg = "--help", version = "0.8.2" }
script = '''
#!/bin/bash
sqlx migrate $@ --source adapter/migrations/sqlite
'''

# =============================================================================
# Dockerタスク
# =============================================================================
[tasks.up]
description = "Start the application in Docker"
extend = "set-env-docker"
dependencies = ["docker-build"]
command = "docker"
args = ["compose", "up", "-d", "app"]

[tasks.down]
description = "Stop Docker containers"
command = "docker"
args = ["compose", "down"]

[tasks.docker-build]
description = "Build Docker image"
command = "docker"
args = ["compose", "build", "app", "--build-arg", "BUILDKIT_INLINE_CACHE=1", "${@}"]

[tasks.logs]
description = "Show Docker container logs"
command = "docker"
args = ["compose", "logs", "-f", "${@}"]

[tasks.clean]
description = "Stop containers and remove volumes"
command = "docker"
args = ["compose", "down", "-v"]

# =============================================================================
# デプロイタスク
# =============================================================================
[tasks.deploy]
description = "Build, push image, and deploy to Fly.io (with pre-deploy backup)"
run_task = { name = ["admin-build", "fly-backup", "docker-push", "fly-deploy"] }

[tasks.deploy-no-backup]
description = "Build, push image, and deploy to Fly.io (without backup)"
run_task = { name = ["admin-build", "docker-push", "fly-deploy"] }

[tasks.docker-push]
description = "Build and push Docker image to registry"
script = '''
#!/bin/bash
set -e
docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} -f Dockerfile.sqlite .
docker push ${DOCKER_IMAGE}:${DOCKER_TAG}
'''

[tasks.fly-deploy]
description = "Deploy to Fly.io"
command = "fly"
args = ["deploy", "${@}"]

[tasks.fly-status]
description = "Show Fly.io app status"
command = "fly"
args = ["status"]

[tasks.fly-logs]
description = "Show Fly.io logs"
command = "fly"
args = ["logs", "${@}"]

[tasks.fly-ssh]
description = "SSH into Fly.io machine"
command = "fly"
args = ["ssh", "console", "${@}"]

# =============================================================================
# データベース管理タスク (Fly.io)
# =============================================================================
[tasks.fly-backup]
description = "Backup database on Fly.io before deploy"
script = '''
#!/bin/bash
set -e

# Check if VM is running
VM_STATE=$(fly status --json 2>/dev/null | grep -o '"state":"[^"]*"' | head -1 | cut -d'"' -f4)
if [ "$VM_STATE" != "started" ]; then
    echo "VM is not running (state: ${VM_STATE:-unknown}). Skipping backup."
    exit 0
fi

TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="/data/backup_${TIMESTAMP}.db"
echo "Creating backup: ${BACKUP_FILE}"
fly ssh console -C "./target/release/app db backup -o ${BACKUP_FILE}"
echo "Backup completed: ${BACKUP_FILE}"
'''

[tasks.fly-db-list]
description = "List database backups on Fly.io"
script = '''
#!/bin/bash
fly ssh console -C "ls -la /data/*.db"
'''

[tasks.fly-db-restore]
description = "Restore database from backup on Fly.io"
script = '''
#!/bin/bash
if [ -z "$1" ]; then
    echo "Usage: makers fly-db-restore <backup_file>"
    echo "Example: makers fly-db-restore /data/backup_20251221_120000.db"
    exit 1
fi
echo "Restoring from: $1"
fly ssh console -C "./target/release/app db restore -i $1"
echo "Restore completed. Restart the app with: fly apps restart"
'''

[tasks.fly-db-reset]
description = "Reset database on Fly.io (DANGEROUS!)"
script = '''
#!/bin/bash
echo "WARNING: This will DELETE ALL DATA!"
echo "Creating backup first..."
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="/data/pre_reset_backup_${TIMESTAMP}.db"
fly ssh console -C "./target/release/app db backup -o ${BACKUP_FILE}"
echo "Backup created: ${BACKUP_FILE}"
echo ""
echo "To proceed with reset, run:"
echo "  fly ssh console -C './target/release/app db reset --force'"
'''

[tasks.fly-db-optimize]
description = "Optimize database on Fly.io"
script = '''
#!/bin/bash
fly ssh console -C "./target/release/app db optimize"
'''

[tasks.fly-db-migrate]
description = "Run database migrations on Fly.io"
script = '''
#!/bin/bash
fly ssh console -C "./target/release/app db migrate"
'''
